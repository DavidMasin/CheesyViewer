<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cheesy Viewer (Compact)</title>
    <style>
        :root{--bg:#0a0d12;--fg:#e8eef7;--muted:#8aa0b8;--red:#e24b4b;--blue:#4aa3ff}
        *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
        .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
        h1{margin:0 0 2px;font-size:26px} .muted{color:var(--muted)}
        .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
        .card{background:#121826;border:1px solid #1b2433;border-radius:14px;padding:14px}
        .teams{display:flex;gap:10px;flex-wrap:wrap}
        .badge{display:inline-flex;align-items:center;gap:8px;background:#0e1420;border:1px solid #1b2433;border-radius:10px;padding:8px 10px}
        .dot{width:10px;height:10px;border-radius:50%}
        table{width:100%;border-collapse:collapse} th,td{padding:8px 10px;border-bottom:1px solid #1b2231} th{color:var(--muted);text-align:left;font-weight:600}
        td.red{color:var(--red)} td.blue{color:var(--blue)}
        .reef-wrap{padding:16px}
        .reef-title{display:flex;align-items:center;gap:10px;margin:6px 2px 10px}
        .legend{display:flex;gap:14px;margin-top:8px}
        .legend .item{display:flex;gap:8px;align-items:center}
        .legend .swatch{width:18px;height:10px;border-radius:4px;border:1px solid #0003}
        .footer{margin-top:16px;font-size:12px;color:var(--muted)}
        .error{color:#ff6565}
        svg.reef{width:100%;height:auto;display:block;background:#0d121d;border:1px solid #1b2433;border-radius:12px}
        a{color:#b9dcff}
    </style>
</head>
<body>
<div class="wrap">
    <h1 id="matchTitle">Cheesy Viewer (Compact)</h1>
    <div id="subtitle" class="muted">Awaiting data…</div>

    <section class="grid" style="margin-top:16px">
        <div class="card">
            <div class="teams">
                <div class="badge"><div class="dot" style="background:var(--red)"></div><div id="teamsRed">—</div></div>
                <div class="badge"><div class="dot" style="background:var(--blue)"></div><div id="teamsBlue">—</div></div>
            </div>

            <h3 style="margin:14px 2px 8px">Breakdown</h3>
            <div class="card" style="padding:0">
                <table>
                    <thead><tr><th>Field</th><th class="red">RED</th><th class="blue">BLUE</th></tr></thead>
                    <tbody id="breakdownBody"></tbody>
                </table>
            </div>

            <div class="footer" id="when"></div>
            <div class="footer" id="rawLink"></div>
        </div>

        <div class="card reef-wrap">
            <div class="reef-title"><div class="dot" style="background:var(--red)"></div><div class="muted">RED Reef</div></div>
            <svg id="reefRed" class="reef" viewBox="0 0 600 520" aria-label="Red reef visualization"></svg>
            <div class="legend">
                <div class="item"><div class="swatch" style="background:#e5f1ff"></div><div class="muted">L1</div></div>
                <div class="item"><div class="swatch" style="background:#cde5ff"></div><div class="muted">L2</div></div>
                <div class="item"><div class="swatch" style="background:#b9dcff"></div><div class="muted">L3</div></div>
                <div class="item"><div class="swatch" style="background:#a3d1ff"></div><div class="muted">L4</div></div>
                <div class="item"><div class="swatch" style="background:var(--red)"></div><div class="muted">Coral pieces</div></div>
            </div>
        </div>
    </section>

    <div class="card reef-wrap" style="margin-top:16px">
        <div class="reef-title"><div class="dot" style="background:var(--blue)"></div><div class="muted">BLUE Reef</div></div>
        <svg id="reefBlue" class="reef" viewBox="0 0 600 520" aria-label="Blue reef visualization"></svg>
        <div class="legend">
            <div class="item"><div class="swatch" style="background:#e5f1ff"></div><div class="muted">L1</div></div>
            <div class="item"><div class="swatch" style="background:#cde5ff"></div><div class="muted">L2</div></div>
            <div class="item"><div class="swatch" style="background:#b9dcff"></div><div class="muted">L3</div></div>
            <div class="item"><div class="swatch" style="background:#a3d1ff"></div><div class="muted">L4</div></div>
            <div class="item"><div class="swatch" style="background:var(--blue)"></div><div class="muted">Coral pieces</div></div>
        </div>
    </div>
</div>

<script>
    // ========================= Base64URL helpers =========================
    function b64urlToBytes(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; var bin=atob(s); var bytes=new Uint8Array(bin.length); for(var i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return bytes; }
    function bytesToB64url(bytes){ var bin=''; for(var i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }

    // ========================= Bit Reader/Writer =========================
    function BitReader(bytes){ this.b=bytes; this.i=0; this.buf=0; this.bits=0; }
    BitReader.prototype.read = function(n){ var out=0; var bitPos=0; while(n>0){ if(this.bits===0){ if(this.i>=this.b.length) return null; this.buf=this.b[this.i++]; this.bits=8; } var take=Math.min(this.bits,n); var mask=(1<<take)-1; out |= ((this.buf & mask) << bitPos); this.buf >>= take; this.bits-=take; n-=take; bitPos+=take; } return out; };

    // ========================= Hash parsing =========================
    function getFrag(){ var h=location.hash||''; if(h.startsWith('#')) h=h.slice(1); return h; }
    function parseHash(){
        var h=getFrag();
        // Preferred: compact packet "p=" (base64url of binary packet)
        var m=h.match(/(?:^|&)p=([^&]+)/); if(m) return {kind:'p', val:m[1]};
        // Fallback: plain JSON "json="
        m=h.match(/(?:^|&)json=([^&]+)/); if(m) return {kind:'json', val:m[1]};
        // Legacy compressed "d="/"data=" (won't be used in compact mode, but supported)
        m=h.match(/(?:^|&)(?:d|data)=([^&]+)/); if(m) return {kind:'lz', val:m[1]};
        return null;
    }

    // ========================= Compact Packet v1 =========================
    // Layout (bits):
    // 8: version (=1)
    // 6 * 14: team numbers (R1,R2,R3,B1,B2,B3) — 0 if missing
    // 24 * 2: RED reef counts (faces A..F, levels 1..4) — clamp 0..3
    // 24 * 2: BLUE reef counts (faces A..F, levels 1..4) — clamp 0..3
    // 4 + 4: RED AlgaeRemoved(0..15), AlgaeProcessed(0..15)
    // 4 + 4: BLUE AlgaeRemoved(0..15), AlgaeProcessed(0..15)
    // Total = 8 + 84 + 48 + 48 + 8 + 8 = 196 bits → 25 bytes (pad to next byte if needed)

    function decodePacketV1(bytes){
        var br=new BitReader(bytes);
        var ver=br.read(8); if(ver!==1) throw new Error('Unsupported packet version '+ver);
        var teams=[]; for(var i=0;i<6;i++){ var t=br.read(14); teams.push(t||0); }
        function readReef(){ var faces='ABCDEF'; var out={}; for(var fi=0;fi<6;fi++){ var f=faces[fi]; out[f]={1:0,2:0,3:0,4:0}; for(var lv=1;lv<=4;lv++){ out[f][lv]=br.read(2); } } return out; }
        var reefR=readReef();
        var reefB=readReef();
        var rAR=br.read(4)||0, rAP=br.read(4)||0, bAR=br.read(4)||0, bAP=br.read(4)||0;
        // Build viewer payload {m?, t:{r,b}, r:{A1..F4, AlgaeRemoved, AlgaeProcessed}, b:{...}}
        function flatten(map){ var o={}; var faces='ABCDEF'; for(var fi=0;fi<6;fi++){ var f=faces[fi]; for(var lv=1;lv<=4;lv++){ o[f+lv]=map[f][lv]; } } return o; }
        var red=flatten(reefR); red.AlgaeRemoved=rAR; red.AlgaeProcessed=rAP;
        var blue=flatten(reefB); blue.AlgaeRemoved=bAR; blue.AlgaeProcessed=bAP;
        return {
            t:{ r:teams.slice(0,3).filter(Boolean), b:teams.slice(3).filter(Boolean) },
            r:red,
            b:blue
        };
    }

    // ========================= LZString (decoder only, safe) =========================
    // Only used if someone still passes #d=/#data=; compact flow won't need it.
    (function(){
        if(window.LZString) return;
        var f=String.fromCharCode, keyStrUriSafe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$", baseReverseDic={};
        function getBaseValue(alphabet, character) { if (!baseReverseDic[alphabet]) { baseReverseDic[alphabet] = {}; for (var i=0; i<alphabet.length; i++) baseReverseDic[alphabet][alphabet.charAt(i)] = i; } return baseReverseDic[alphabet][character]; }
        function _decompress(length, resetValue, getNextValue) { var dictionary = [], enlargeIn = 4, dictSize = 4, numBits = 3, entry = "", result = [], i, w, bits, resb, maxpower, power, data = { val: getNextValue(0), position: resetValue, index: 1 }; for (i=0; i<3; i+=1) dictionary[i] = i; bits = 0; maxpower = Math.pow(2,2); power = 1; while (power != maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0 ? 1 : 0) * power; power <<= 1; } switch (bits) { case 0: bits = 0; maxpower = Math.pow(2,8); power = 1; while (power != maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0 ? 1 : 0) * power; power <<= 1; } entry = f(bits); break; case 1: bits = 0; maxpower = Math.pow(2,16); power = 1; while (power != maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0 ? 1 : 0) * power; power <<= 1; } entry = f(bits); break; case 2: return ""; } dictionary[3] = entry; var w = entry; result.push(entry); while (true) { if (data.index > length) return ""; bits = 0; maxpower = Math.pow(2, numBits); power = 1; while (power != maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0 ? 1 : 0) * power; power <<= 1; } var cnum = bits, str; switch (cnum) { case 0: bits = 0; maxpower = Math.pow(2,8); power = 1; while (power != maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0 ? 1 : 0) * power; power <<= 1; } dictionary[dictSize++] = f(bits); cnum = dictSize - 1; enlargeIn--; break; case 1: bits = 0; maxpower = Math.pow(2,16); power = 1; while (power != maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0 ? 1 : 0) * power; power <<= 1; } dictionary[dictSize++] = f(bits); cnum = dictSize - 1; enlargeIn--; break; case 2: return result.join(""); } if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; } if (dictionary[cnum]) str = dictionary[cnum]; else { if (cnum === dictSize) str = w + w.charAt(0); else return null; } result.push(str); dictionary[dictSize++] = w + str.charAt(0); enlargeIn--; w = str; if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; } } }
        window.LZString = { decompressFromEncodedURIComponent: function (input) { if (input == null) return ""; if (input === "") return null; input = input.replace(/ /g, "+"); return _decompress(input.length, 32, function(i){ return getBaseValue(keyStrUriSafe, input.charAt(i)); }); } };
    })();

    // ========================= UI helpers =========================
    function byId(id){return document.getElementById(id)}
    function setText(id, val){var el=byId(id); if(el) el.textContent = (val==null? "": String(val))}

    function extractReefCountsFromScore(score){
        var out={}, faces='ABCDEF';
        for(var fi=0;fi<6;fi++){ var f=faces[fi]; for(var lv=1;lv<=4;lv++){ var k=f+lv; var v=score[k]; if(typeof v==='number') out[k]=v; }}
        out.AlgaeRemoved = typeof score.AlgaeRemoved==='number' ? score.AlgaeRemoved : 0;
        out.AlgaeProcessed = typeof score.AlgaeProcessed==='number' ? score.AlgaeProcessed : 0;
        return out;
    }

    function renderReef(svgId, counts){
        var svg=byId(svgId); if(!svg) return; svg.innerHTML="";
        var W=600,H=520,CX=W/2,CY=H/2; var R=[120,180,240,280];
        function slicePath(cx,cy,r0,r1,a0,a1){ function p(r,a){return [cx+r*Math.cos(a), cy+r*Math.sin(a)];} var p0=p(r0,a0), p1=p(r0,a1), p2=p(r1,a1), p3=p(r1,a0); return `M${p0[0]},${p0[1]} A${r0},${r0} 0 0 1 ${p1[0]},${p1[1]} L${p2[0]},${p2[1]} A${r1},${r1} 0 0 0 ${p3[0]},${p3[1]} Z`; }
        var faces='ABCDEF';
        for(var fi=0; fi<6; fi++){
            var a0 = (Math.PI*2)*fi/6 - Math.PI/2, a1=(Math.PI*2)*(fi+1)/6 - Math.PI/2;
            for(var lv=1; lv<=4; lv++){
                var k=faces[fi]+lv; var v = counts[k]||0; var r0=R[lv-1]-(lv===1?25:20), r1=R[lv-1]+(lv===4?25:20);
                var p = document.createElementNS("http://www.w3.org/2000/svg","path"); p.setAttribute("d",slicePath(CX,CY,r0,r1,a0,a1)); var shades=[0.94,0.90,0.86,0.82]; p.setAttribute("fill",`rgba(90,150,255,${(1-shades[lv-1]).toFixed(2)})`); p.setAttribute("stroke","#0b1220"); p.setAttribute("stroke-width","1.2"); svg.appendChild(p);
                if(v>0){ var midr=(r0+r1)/2, mida=(a0+a1)/2; var tx=CX+midr*Math.cos(mida), ty=CY+midr*Math.sin(mida); var t = document.createElementNS("http://www.w3.org/2000/svg","text"); t.setAttribute("x",tx); t.setAttribute("y",ty); t.setAttribute("text-anchor","middle"); t.setAttribute("dominant-baseline","middle"); t.setAttribute("font-size","16"); t.textContent=String(v); svg.appendChild(t); }
            }
        }
    }

    function renderAll(payload){
        var red = payload.r || payload.RedScore || (payload.result && (payload.result.RedScore||payload.result.red)) || {};
        var blue= payload.b || payload.BlueScore|| (payload.result && (payload.result.BlueScore||payload.result.blue)) || {};
        var title = payload.m || (payload.match && payload.match.lite && payload.match.lite.longName) || payload.match || "Match";
        setText('matchTitle', title + (payload.eventName ? " — " + payload.eventName : ""));
        setText('subtitle', 'Reef + breakdown');
        // Teams
        var rTeams=(payload.t && payload.t.r) || (payload.teams && (payload.teams.red||payload.teams.r)) || [];
        var bTeams=(payload.t && payload.t.b) || (payload.teams && (payload.teams.blue||payload.teams.b)) || [];
        setText('teamsRed', (rTeams||[]).join(' • ')); setText('teamsBlue', (bTeams||[]).join(' • '));
        // Breakdown
        (function(){ var tbody=document.getElementById('breakdownBody'); if(!tbody) return; tbody.innerHTML='';
            function addRow(n, rv, bv){ var tr=document.createElement('tr'); tr.innerHTML='<td>'+n+'</td><td class="red">'+(rv??'')+'</td><td class="blue">'+(bv??'')+'</td>'; tbody.appendChild(tr); }
            var faces='ABCDEF'; for(var fi=0;fi<6;fi++){ for(var lv=1;lv<=4;lv++){ var k=faces[fi]+lv; if((red[k]??0)!==0 || (blue[k]??0)!==0) addRow(k, red[k], blue[k]); } }
            addRow('AlgaeRemoved', red.AlgaeRemoved||0, blue.AlgaeRemoved||0);
            addRow('AlgaeProcessed', red.AlgaeProcessed||0, blue.AlgaeProcessed||0);
        })();
        // Reef visuals
        renderReef('reefRed',  extractReefCountsFromScore(red));
        renderReef('reefBlue', extractReefCountsFromScore(blue));
        // Footer
        try{ var blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); document.getElementById('rawLink').innerHTML='<a href="'+url+'" download="match.json">Download raw</a>'; }catch(_){ }
    }

    function showError(msg){ var el=document.getElementById('subtitle'); if(el) el.innerHTML='<span class="error">'+msg+'</span>'; console.error('[VIEWER]', msg); }

    (function main(){
        try{
            var frag=parseHash();
            if(!frag){
                if((location.search||'').match(/(^|[?&])demo=1(&|$)/)){
                    // build a tiny demo packet
                    var bytes=new Uint8Array(25); // enough for v1 (we'll fill bits procedurally)
                    var bit=0; function put(val,bits){ for(var i=0;i<bits;i++){ var bitval=(val>>i)&1; var idx=(bit>>3); var off=(bit&7); bytes[idx]|=(bitval<<off); bit++; } }
                    put(1,8); // version
                    var demoTeams=[111,222,333,444,555,666]; for(var i=0;i<6;i++) put(demoTeams[i],14);
                    function putReef(fill){ var faces=6, levels=4; for(var f=0;f<faces;f++){ for(var lv=1;lv<=levels;lv++){ put(fill(f,lv),2); } } }
                    putReef(function(f,lv){ return (f===0&&lv===1)?2 : (f===1&&lv===2)?1 : 0; }); // RED
                    putReef(function(f,lv){ return (f===2&&lv===3)?2 : (f===3&&lv===4)?1 : 0; }); // BLUE
                    put(2,4); put(1,4); // R algae removed/processed
                    put(1,4); put(2,4); // B algae removed/processed
                    var p = bytesToB64url(bytes);
                    location.replace(location.origin+location.pathname+'#p='+p);
                    return;
                }
                showError('No data. Expect #p= (compact) or #json= …'); return;
            }
            if(frag.kind==='p'){
                var bytes=b64urlToBytes(frag.val); var payload=decodePacketV1(bytes); renderAll(payload); return;
            }
            if(frag.kind==='json'){
                var raw=decodeURIComponent(frag.val); var payload=JSON.parse(raw); renderAll(payload); return;
            }
            if(frag.kind==='lz'){
                if(!window.LZString||!LZString.decompressFromEncodedURIComponent) throw new Error('LZString missing');
                var raw=LZString.decompressFromEncodedURIComponent(frag.val); if(!raw) throw new Error('Failed to decode compressed data');
                var payload=JSON.parse(raw); renderAll(payload); return;
            }
        }catch(err){ showError((err&&err.message)||String(err)); }
    })();
</script>
</body>
</html>