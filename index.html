<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cheesy Viewer</title>
    <style>
        :root{--bg:#0a0d12;--fg:#e8eef7;--muted:#8aa0b8;--red:#e24b4b;--blue:#4aa3ff}
        *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
        .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
        h1{margin:0 0 2px;font-size:26px} .muted{color:var(--muted)}
        .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
        .card{background:#121826;border:1px solid #1b2433;border-radius:14px;padding:14px}
        .teams{display:flex;gap:10px;flex-wrap:wrap}
        .badge{display:inline-flex;align-items:center;gap:8px;background:#0e1420;border:1px solid #1b2433;border-radius:10px;padding:8px 10px}
        .dot{width:10px;height:10px;border-radius:50%}
        table{width:100%;border-collapse:collapse} th,td{padding:8px 10px;border-bottom:1px solid #1b2231} th{color:var(--muted);text-align:left;font-weight:600}
        td.red{color:var(--red)} td.blue{color:var(--blue)}
        .reef-wrap{padding:16px}
        .reef-title{display:flex;align-items:center;gap:10px;margin:6px 2px 10px}
        .legend{display:flex;gap:14px;margin-top:8px}
        .legend .item{display:flex;gap:8px;align-items:center}
        .legend .swatch{width:18px;height:10px;border-radius:4px;border:1px solid #0003}
        .footer{margin-top:16px;font-size:12px;color:var(--muted)}
        .error{color:#ff6565}
        svg.reef{width:100%;height:auto;display:block;background:#0d121d;border:1px solid #1b2433;border-radius:12px}
        a{color:#b9dcff}
    </style>
</head>
<body>
<div class="wrap">
    <h1 id="matchTitle">Cheesy Viewer</h1>
    <div id="subtitle" class="muted">Awaiting data…</div>

    <section class="grid" style="margin-top:16px">
        <div class="card">
            <div class="teams">
                <div class="badge"><div class="dot" style="background:var(--red)"></div><div id="teamsRed">—</div></div>
                <div class="badge"><div class="dot" style="background:var(--blue)"></div><div id="teamsBlue">—</div></div>
            </div>

            <h3 style="margin:14px 2px 8px">Breakdown</h3>
            <div class="card" style="padding:0">
                <table>
                    <thead><tr><th>Field</th><th class="red">RED</th><th class="blue">BLUE</th></tr></thead>
                    <tbody id="breakdownBody"></tbody>
                </table>
            </div>

            <div class="footer" id="when"></div>
            <div class="footer" id="rawLink"></div>
        </div>

        <div class="card reef-wrap">
            <div class="reef-title"><div class="dot" style="background:var(--red)"></div><div class="muted">RED Reef</div></div>
            <svg id="reefRed" class="reef" viewBox="0 0 600 520" aria-label="Red reef visualization"></svg>
            <div class="legend">
                <div class="item"><div class="swatch" style="background:#e5f1ff"></div><div class="muted">L1</div></div>
                <div class="item"><div class="swatch" style="background:#cde5ff"></div><div class="muted">L2</div></div>
                <div class="item"><div class="swatch" style="background:#b9dcff"></div><div class="muted">L3</div></div>
                <div class="item"><div class="swatch" style="background:#a3d1ff"></div><div class="muted">L4</div></div>
                <div class="item"><div class="swatch" style="background:var(--red)"></div><div class="muted">Coral pieces</div></div>
            </div>
        </div>
    </section>

    <div class="card reef-wrap" style="margin-top:16px">
        <div class="reef-title"><div class="dot" style="background:var(--blue)"></div><div class="muted">BLUE Reef</div></div>
        <svg id="reefBlue" class="reef" viewBox="0 0 600 520" aria-label="Blue reef visualization"></svg>
        <div class="legend">
            <div class="item"><div class="swatch" style="background:#e5f1ff"></div><div class="muted">L1</div></div>
            <div class="item"><div class="swatch" style="background:#cde5ff"></div><div class="muted">L2</div></div>
            <div class="item"><div class="swatch" style="background:#b9dcff"></div><div class="muted">L3</div></div>
            <div class="item"><div class="swatch" style="background:#a3d1ff"></div><div class="muted">L4</div></div>
            <div class="item"><div class="swatch" style="background:var(--blue)"></div><div class="muted">Coral pieces</div></div>
        </div>
    </div>
</div>

<!-- Safe, pretty-printed LZString decoder (only decompressFromEncodedURIComponent) -->
<script>
    window.LZString = window.LZString || (function(){
        var f = String.fromCharCode;
        var keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
        var baseReverseDic = {};
        function getBaseValue(alphabet, character) {
            if (!baseReverseDic[alphabet]) {
                baseReverseDic[alphabet] = {};
                for (var i=0; i<alphabet.length; i++) baseReverseDic[alphabet][alphabet.charAt(i)] = i;
            }
            return baseReverseDic[alphabet][character];
        }
        function _decompress(length, resetValue, getNextValue) {
            var dictionary = [], enlargeIn = 4, dictSize = 4, numBits = 3,
                entry = "", result = [], i, w, bits, resb, maxpower, power,
                data = { val: getNextValue(0), position: resetValue, index: 1 };
            for (i=0; i<3; i+=1) dictionary[i] = i;

            bits = 0; maxpower = Math.pow(2,2); power = 1;
            while (power != maxpower) {
                resb = data.val & data.position; data.position >>= 1;
                if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                bits |= (resb>0 ? 1 : 0) * power; power <<= 1;
            }
            switch (bits) {
                case 0:
                    bits = 0; maxpower = Math.pow(2,8); power = 1;
                    while (power != maxpower) {
                        resb = data.val & data.position; data.position >>= 1;
                        if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                        bits |= (resb>0 ? 1 : 0) * power; power <<= 1;
                    }
                    entry = f(bits); break;
                case 1:
                    bits = 0; maxpower = Math.pow(2,16); power = 1;
                    while (power != maxpower) {
                        resb = data.val & data.position; data.position >>= 1;
                        if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                        bits |= (resb>0 ? 1 : 0) * power; power <<= 1;
                    }
                    entry = f(bits); break;
                case 2: return "";
            }
            dictionary[3] = entry; var w = entry; result.push(entry);

            while (true) {
                if (data.index > length) return "";
                bits = 0; maxpower = Math.pow(2, numBits); power = 1;
                while (power != maxpower) {
                    resb = data.val & data.position; data.position >>= 1;
                    if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                    bits |= (resb>0 ? 1 : 0) * power; power <<= 1;
                }
                var cnum = bits, str;
                switch (cnum) {
                    case 0:
                        bits = 0; maxpower = Math.pow(2,8); power = 1;
                        while (power != maxpower) {
                            resb = data.val & data.position; data.position >>= 1;
                            if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                            bits |= (resb>0 ? 1 : 0) * power; power <<= 1;
                        }
                        dictionary[dictSize++] = f(bits); cnum = dictSize - 1; enlargeIn--; break;
                    case 1:
                        bits = 0; maxpower = Math.pow(2,16); power = 1;
                        while (power != maxpower) {
                            resb = data.val & data.position; data.position >>= 1;
                            if (data.position === 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                            bits |= (resb>0 ? 1 : 0) * power; power <<= 1;
                        }
                        dictionary[dictSize++] = f(bits); cnum = dictSize - 1; enlargeIn--; break;
                    case 2: return result.join("");
                }
                if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
                if (dictionary[cnum]) str = dictionary[cnum];
                else { if (cnum === dictSize) str = w + w.charAt(0); else return null; }
                result.push(str);
                dictionary[dictSize++] = w + str.charAt(0);
                enlargeIn--; w = str;
                if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
            }
        }
        return {
            decompressFromEncodedURIComponent: function (input) {
                if (input == null) return "";
                if (input === "") return null;
                input = input.replace(/ /g, "+");
                return _decompress(input.length, 32, function(i){
                    return getBaseValue(keyStrUriSafe, input.charAt(i));
                });
            }
        };
    })();
</script>

<script>
    // Utilities
    function byId(id){return document.getElementById(id)}
    function setText(id, val){var el=byId(id); if(el) el.textContent = (val==null? "": String(val))}

    // Parse #json= (preferred), #d= / #data= (compressed)
    function readPackedFromHash(){
        var h = location.hash || "";
        var keys = ["json=", "d=", "data="]; // try plain JSON first
        for (var i=0;i<keys.length;i++){
            var k = keys[i], idx = h.indexOf(k);
            if (idx !== -1){
                var v = h.substring(idx + k.length);
                var a = v.indexOf("&"); if (a !== -1) v = v.substring(0, a);
                return { key: k.slice(0,-1), value: v };
            }
        }
        return null;
    }

    function showError(msg){
        var el = document.getElementById("subtitle");
        if (el) el.innerHTML = '<span class="error">'+msg+'</span>';
        try { console.error("[VIEWER]", msg); } catch(_){ }
    }

    // --- Reef helpers (extract counts A..F × L1..4) ---
    function emptyCounts(){ var faces=['A','B','C','D','E','F'], c={}; for(var i=0;i<faces.length;i++){ c[faces[i]]={1:0,2:0,3:0,4:0}; } return c; }
    function addCount(map, face, level, delta){ if(!map||!face||!map[face]) return; var lv=parseInt(level,10); if(isNaN(lv)||lv<1||lv>4) return; map[face][lv]+= (delta||1); }
    function isFace(k){return /^[A-F]$/.test(k)}
    function isFaceLevel(k){return /^[A-F][1-4]$/.test(k)}
    function extractReefCounts(score){
        var out=emptyCounts(); if(!score||typeof score!=="object") return out;
        for(var k in score){ if(isFaceLevel(k)){ var v=score[k]; if(typeof v==="number"&&v>0) addCount(out,k[0],k[1],v); else if(v===true) addCount(out,k[0],k[1],1); }}
        for(var fk in score){ if(isFace(fk)){ var v=score[fk]; if(Array.isArray(v)){ for(var i=0;i<Math.min(4,v.length);i++){ if(typeof v[i]==="number") addCount(out,fk,i+1,v[i]); }}
        else if(v&&typeof v==="object"){ for(var lk in v){ var lv=lk.replace(/[^1-4]/g,""); if(lv){ var n=v[lk]; if(typeof n==="number"&&n>0) addCount(out,fk,lv,n); else if(n===true) addCount(out,fk,lv,1); } } } } }
        function walk(x){ if(!x) return; if(Array.isArray(x)){ for(var i=0;i<x.length;i++){ var it=x[i]; if(typeof it==="string"&&isFaceLevel(it)) addCount(out,it[0],it[1],1); else if(it&&typeof it==="object") walk(it); } }
        else if(typeof x==="object"){ for(var kk in x){ var vv=x[kk]; if(typeof vv==="string"&&isFaceLevel(vv)) addCount(out,vv[0],vv[1],1); else walk(vv); } } }
        walk(score);
        return out;
    }

    // Draw reef as 4 rings (L1..L4), 6 faces
    function renderReef(svgId, counts){
        var svg=byId(svgId); if(!svg) return; svg.innerHTML="";
        var W=600,H=520,CX=W/2,CY=H/2;
        var R=[120,180,240,280]; // L1..L4 radii
        function slicePath(cx,cy,r0,r1,a0,a1){
            function p(r,a){return [cx+r*Math.cos(a), cy+r*Math.sin(a)];}
            var p0=p(r0,a0), p1=p(r0,a1), p2=p(r1,a1), p3=p(r1,a0);
            return "M"+p0[0]+","+p0[1]+" A"+r0+","+r0+" 0 0 1 "+p1[0]+","+p1[1]+" L"+p2[0]+","+p2[1]+" A"+r1+","+r1+" 0 0 0 "+p3[0]+","+p3[1]+" Z";
        }
        var faces="ABCDEF";
        for(var fi=0; fi<6; fi++){
            var a0 = (Math.PI*2)*fi/6 - Math.PI/2, a1=(Math.PI*2)*(fi+1)/6 - Math.PI/2;
            for(var lv=1; lv<=4; lv++){
                var v = counts[faces[fi]][lv] || 0;
                var r0=R[lv-1]-(lv===1?25:20), r1=R[lv-1]+(lv===4?25:20);
                var p = document.createElementNS("http://www.w3.org/2000/svg","path");
                p.setAttribute("d",slicePath(CX,CY,r0,r1,a0,a1));
                var shades=[0.94,0.90,0.86,0.82];
                p.setAttribute("fill","rgba(90,150,255,"+(1-shades[lv-1]).toFixed(2)+")");
                p.setAttribute("stroke","#0b1220"); p.setAttribute("stroke-width","1.2");
                svg.appendChild(p);
                if(v>0){
                    var midr=(r0+r1)/2, mida=(a0+a1)/2;
                    var tx=CX+midr*Math.cos(mida), ty=CY+midr*Math.sin(mida);
                    var t = document.createElementNS("http://www.w3.org/2000/svg","text");
                    t.setAttribute("x",tx); t.setAttribute("y",ty);
                    t.setAttribute("text-anchor","middle"); t.setAttribute("dominant-baseline","middle");
                    t.setAttribute("font-size","16"); t.textContent=String(v);
                    svg.appendChild(t);
                }
            }
        }
    }

    function renderAll(payload){
        // Support minimal (#d/#data: r/b/m/t) and legacy full (result.RedScore/BlueScore)
        var red = payload.r || (payload.result && (payload.result.RedScore || payload.result.red)) || {};
        var blue= payload.b || (payload.result && (payload.result.BlueScore|| payload.result.blue)) || {};
        var title = payload.m || (payload.match && payload.match.lite && payload.match.lite.longName) || payload.match || "Match";

        setText('matchTitle', title + (payload.eventName ? " — " + payload.eventName : ""));
        setText('subtitle', 'Reef + breakdown');

        // Teams
        var rTeams=(payload.t && payload.t.r) || (payload.teams && payload.teams.red) || [];
        var bTeams=(payload.t && payload.t.b) || (payload.teams && payload.teams.blue) || [];
        setText('teamsRed', (rTeams||[]).join(' • ')); setText('teamsBlue', (bTeams||[]).join(' • '));

        // Breakdown table: list all numeric keys present in either side
        (function(){
            var tbody=byId('breakdownBody'); if(!tbody) return; tbody.innerHTML='';
            var keys={},k; for(k in red){ if(typeof red[k]==='number') keys[k]=1; }
            for(k in blue){ if(typeof blue[k]==='number') keys[k]=1; }
            var list=Object.keys(keys).sort();
            for(var i=0;i<list.length;i++){
                var key=list[i], rv=red[key], bv=blue[key];
                var row=document.createElement('tr');
                row.innerHTML='<td>'+key+'</td><td class="red">'+(rv!=null?rv:'')+'</td><td class="blue">'+(bv!=null?bv:'')+'</td>';
                tbody.appendChild(row);
            }
        })();

        // Reef
        renderReef('reefRed',  extractReefCounts(red));
        renderReef('reefBlue', extractReefCounts(blue));

        // Footer
        try {
            var stamp=payload.generated?new Date(payload.generated):new Date();
            setText('when','Generated '+stamp.toLocaleString());
            var blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
            var url=URL.createObjectURL(blob);
            byId('rawLink').innerHTML='<a href="'+url+'" download="cheesy_match.json">Download raw JSON</a>';
        } catch(_){ }
    }

    (function main(){
        try{
            var packed = readPackedFromHash();
            if (packed){
                var raw;
                if (packed.key === "json"){
                    raw = decodeURIComponent(packed.value);   // <— this path will be used now
                } else {
                    // compressed path
                    if (!window.LZString || !LZString.decompressFromEncodedURIComponent)
                        throw new Error("LZString not available to decode");
                    raw = LZString.decompressFromEncodedURIComponent(packed.value);
                    if (!raw) throw new Error("Failed to decode compressed data");
                }
                var payload = JSON.parse(raw);
                renderAll(payload);
                return;
            }

            // Demo fallback
            if ((location.search||"").match(/(^|[?&])demo=1(&|$)/)) {
                var sample = { eventName:"Demo Event", m:"Q1",
                    t:{r:[111,222,333], b:[444,555,666]},
                    r:{TotalPoints:96, A1:2, A2:1, A3:1, AlgaeRemoved:2, AlgaeProcessed:1},
                    b:{TotalPoints:91, B1:1, C2:2, D3:1, E4:1} };
                renderAll(sample); return;
            }
            showError("No data in URL. Use #json=… (or ?demo=1).");
        } catch (err) {
            showError((err && err.message) || String(err));
        }
    })();
</script>
</body>
</html>
